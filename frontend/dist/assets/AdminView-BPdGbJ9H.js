/* empty css                 */import{C as Ye,D as M,d as Ue,r as m,p as ue,q as Ee,c as _,m as s,b as e,k as Se,w as l,l as g,f as Oe,i as Ge,G as Ne,H as Fe,F as Q,v as X,g as Y,h as B,t as A,I as je,J as Ze,K as el,L as qe,M as x,N as ll,O as He,P as al,Q as tl,R as Le,S as Be,j as Te,T as Ke,U as Je,V as sl,A as We,n as v,W as we,_ as ol,X as nl,o as c,Y as Qe,B as dl,u as rl,a as xe,e as il,Z as ul,$ as cl,a0 as ml,a1 as pl,a2 as vl,a3 as _l,a4 as fl,a5 as Re,a6 as gl,a7 as yl,a8 as wl,a9 as bl,aa as hl,ab as kl,ac as Vl,ad as $l,ae as Pl,af as Cl,ag as Ml,ah as Al,E as xl,x as Il,ai as Ul,aj as El,ak as Sl}from"./index-DxKlfA5R.js";import{_ as ze}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{k as Tl}from"./marked.esm-z4go5P_g.js";const De=Ye("admin",()=>({getUsers:async()=>(await M.get("/admin/users")).users,getUser:async d=>await M.get(`/admin/users/${d}`),updateUserPassword:async(d,u)=>{await M.put(`/admin/users/${d}/password`,{new_password:u})},deleteUser:async d=>{await M.delete(`/admin/users/${d}`)},toggleUserAdmin:async d=>{await M.put(`/admin/users/${d}/toggle-admin`)},getProviders:async()=>(await M.get("/admin/providers")).providers,getProvider:async d=>await M.get(`/admin/providers/${d}`),createProvider:async d=>await M.post("/admin/providers",d),updateProvider:async(d,u)=>await M.put(`/admin/providers/${d}`,u),deleteProvider:async d=>{await M.delete(`/admin/providers/${d}`)},toggleProvider:async d=>await M.put(`/admin/providers/${d}/toggle`),getAvailableModels:async(d,u)=>{const r=u?`/admin/providers/${d}/models/available?api_type=${u}`:`/admin/providers/${d}/models/available`;return(await M.get(r)).models},testConnection:async(d,u)=>{const r=u?`/admin/providers/${d}/test?model_id=${u}`:`/admin/providers/${d}/test`;return await M.get(r)},getModels:async d=>{const u=d?`/admin/models?provider_id=${d}`:"/admin/models";return(await M.get(u)).models},getModel:async d=>await M.get(`/admin/models/${d}`),createModel:async d=>await M.post("/admin/models",d),updateModel:async(d,u)=>await M.put(`/admin/models/${d}`,u),deleteModel:async d=>{await M.delete(`/admin/models/${d}`)},toggleModel:async d=>await M.put(`/admin/models/${d}/toggle`),testModel:async d=>await M.post(`/admin/models/${d}/test`),updateModelCapabilities:async(d,u)=>await M.put(`/admin/models/${d}/capabilities`,{capabilities:u})})),zl={class:"provider-management"},Dl={class:"game-ai-config",style:{"margin-bottom":"24px"}},Ll={class:"config-header"},Bl={class:"config-content"},Rl={class:"game-model-list"},Ol={class:"game-info"},Gl={class:"game-name"},Nl={key:0,class:"no-games"},Fl={style:{"margin-bottom":"24px"}},jl={class:"page-header"},ql={key:0,class:"empty-state"},Hl={key:1,class:"providers-list"},Kl={class:"provider-header"},Jl={class:"provider-title"},Wl={style:{margin:"0 8px","font-size":"16px","font-weight":"500"}},Ql={class:"provider-actions"},Xl={class:"provider-fields"},Yl={class:"field-item"},Zl={class:"field-item"},ea={class:"field-label"},la={key:0,style:{"font-size":"12px",color:"#909399"}},aa={class:"models-header"},ta={class:"field-label"},sa={class:"models-list"},oa={key:0,class:"models-empty"},na={class:"model-info"},da={class:"model-name"},ra={class:"model-actions"},ia={class:"provider-types"},ua=["onClick"],ca={key:0,style:{"margin-left":"12px",color:"#67c23a"}},ma={class:"model-select-list"},pa=["onClick"],va={key:0,class:"model-select-empty"},_a=Ue({__name:"ProviderManagement",setup(ve){const w=De(),z=m([]),q=m(!1),$=m(!1),b=m(!1),I=m(!1),P=m(!1),h=m(null),C=m(null),k=m(null),R=m(!1),E=m([]),D=m(""),U=m(""),S=m(null),K=m([]),T=m({defaultModelId:"",gameModels:{}}),L=m(!1),G=ue(()=>{const t=[];for(const a of z.value)if(a.models)for(const f of a.models)f.enabled&&a.enabled&&t.push({...f,provider:a});return t}),y=m({type:"openai",name:"",api_key:"",base_url:""}),d=m({model_id:"",name:"",api_type:"openai",provider_id:0}),u=[{value:"openai",label:"OpenAI",description:"GPT-4, GPT-3.5等模型"},{value:"anthropic",label:"Anthropic",description:"Claude系列模型"},{value:"google",label:"Google",description:"Gemini系列模型"},{value:"custom",label:"自定义",description:"兼容OpenAI格式的API"}],r=ue(()=>{if(!D.value.trim())return E.value;const t=D.value.toLowerCase().trim().split(/\s+/);return E.value.filter(a=>{const f=a.toLowerCase();return t.every(F=>f.includes(F))})}),N=t=>({openai:"OpenAI",anthropic:"Anthropic",google:"Google",custom:"自定义"})[t]||t,J=t=>({openai:"success",anthropic:"",google:"warning",custom:"info"})[t]||"info",ne=t=>({openai:"https://api.openai.com/v1/chat/completions",anthropic:"https://api.anthropic.com/v1/messages",google:"https://generativelanguage.googleapis.com/v1beta",custom:"https://api.example.com/v1"})[t]||"",de=t=>({openai:"OpenAI",anthropic:"Claude",google:"Gemini"})[t]||t,ce=t=>({openai:"success",anthropic:"",google:"warning"})[t]||"info",i=async()=>{q.value=!0;try{z.value=await w.getProviders()}catch(t){v.error(t.message||"加载提供商失败")}finally{q.value=!1}},n=t=>{$.value=!1,y.value={type:t,name:N(t),api_key:"",base_url:""},b.value=!0},O=t=>{h.value=t,y.value={type:t.type,name:t.name,api_key:t.api_key,base_url:t.base_url||""},b.value=!0},se=async t=>{try{await w.toggleProvider(t.id)}catch(a){t.enabled=!t.enabled,v.error(a.message||"操作失败")}},_e=async t=>{try{await w.updateProvider(t.id,{api_key:t.api_key,base_url:t.base_url})}catch(a){v.error(a.message||"更新失败")}},be=async t=>{try{await we.confirm(`确定要删除提供商 "${t.name}" 吗？这将同时删除其所有模型配置。`,"确认删除",{type:"warning"}),await w.deleteProvider(t.id),v.success("删除成功"),await i()}catch(a){a!=="cancel"&&v.error(a.message||"删除失败")}},fe=async()=>{if(!y.value.name||!y.value.api_key){v.warning("请填写必填项");return}P.value=!0;try{h.value?(await w.updateProvider(h.value.id,y.value),v.success("更新成功")):(await w.createProvider(y.value),v.success("添加成功")),b.value=!1,h.value=null,await i()}catch(t){v.error(t.message||"保存失败")}finally{P.value=!1}},he=t=>{k.value=t,C.value=null,d.value={model_id:"",name:"",api_type:t.type==="custom"?"openai":t.type,provider_id:t.id},E.value=[],D.value="",U.value="",I.value=!0},ge=(t,a)=>{k.value=t,C.value=a,d.value={model_id:a.model_id,name:a.name,api_type:a.api_type||t.type,provider_id:t.id},E.value=[],D.value="",U.value="",I.value=!0},ke=async t=>{try{await w.toggleModel(t.id)}catch(a){t.enabled=!t.enabled,v.error(a.message||"操作失败")}},Ve=async(t,a)=>{try{await we.confirm(`确定要删除模型 "${a.name}" 吗？`,"确认删除",{type:"warning"}),await w.deleteModel(a.id),v.success("删除成功"),await i()}catch(f){f!=="cancel"&&v.error(f.message||"删除失败")}},$e=async(t,a)=>{S.value=a.id;try{const{AIService:f}=await ol(async()=>{const{AIService:ae}=await Promise.resolve().then(()=>ga);return{AIService:ae}},void 0),F=await f.testConnection({provider_id:t.id,model_id:a.model_id,api_type:a.api_type||t.type});F.success?v.success(`模型 "${a.name}" 连接测试成功`):v.error(`测试失败: ${F.message}`)}catch(f){v.error(`测试失败: ${f.message}`)}finally{S.value=null}},ee=()=>{E.value=[],U.value=""},re=async()=>{if(k.value){R.value=!0,U.value="";try{const t=await w.getAvailableModels(k.value.id,d.value.api_type);E.value=t,t.length===0?U.value="未找到可用模型":v.success(`获取到 ${t.length} 个模型`)}catch(t){U.value=t.message||"获取模型列表失败，请检查API密钥和URL配置"}finally{R.value=!1}}},Pe=t=>{d.value.model_id=t,d.value.name=t},Z=async()=>{if(!d.value.model_id||!d.value.name){v.warning("请填写模型ID和名称");return}P.value=!0;try{C.value?(await w.updateModel(C.value.id,d.value),v.success("更新成功")):(await w.createModel(d.value),v.success("添加成功")),le(),await i()}catch(t){v.error(t.message||"保存失败")}finally{P.value=!1}},le=()=>{I.value=!1,C.value=null,k.value=null,E.value=[],D.value="",U.value=""},Ce=async()=>{try{const t=await fetch("/api/game/mods",{headers:{Authorization:`Bearer ${localStorage.getItem("token")}`}});t.ok&&(K.value=await t.json())}catch(t){console.error("加载游戏列表失败:",t)}},Me=async()=>{try{const t=await fetch("/api/admin/game/model-config",{headers:{Authorization:`Bearer ${localStorage.getItem("token")}`}});if(t.ok){const a=await t.json();T.value.defaultModelId=a.default_model_id||"",T.value.gameModels=a.game_models||{}}}catch(t){console.error("加载游戏配置失败:",t)}},oe=async()=>{L.value=!0;try{const t=await fetch("/api/admin/game/model-config",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("token")}`},body:JSON.stringify({default_model_id:T.value.defaultModelId,game_models:T.value.gameModels})});if(t.ok)v.success("游戏AI配置已保存");else{const a=await t.json();v.error(a.error||"保存失败")}}catch(t){v.error(t.message||"保存失败")}finally{L.value=!1}};return Ee(()=>{i(),Ce(),Me()}),(t,a)=>{const f=Se,F=Fe,ae=Ne,j=Ge,ie=je,p=Oe,ye=Ze,H=qe,me=al,te=Te,Ae=Ke,Xe=nl;return c(),_("div",zl,[s("div",Dl,[s("div",Ll,[a[14]||(a[14]=s("h3",null,"🎮 游戏AI配置",-1)),e(f,{type:"success",size:"small",onClick:oe,loading:L.value},{default:l(()=>[...a[13]||(a[13]=[g(" 保存配置 ",-1)])]),_:1},8,["loading"])]),s("div",Bl,[e(p,{"label-width":"120px"},{default:l(()=>[e(j,{label:"默认模型"},{default:l(()=>[e(ae,{modelValue:T.value.defaultModelId,"onUpdate:modelValue":a[0]||(a[0]=o=>T.value.defaultModelId=o),placeholder:"选择默认AI模型",style:{width:"100%"}},{default:l(()=>[e(F,{label:"自动选择第一个启用的模型",value:""}),(c(!0),_(Q,null,X(G.value,o=>(c(),Y(F,{key:o.id,label:`${o.provider.name} / ${o.name}`,value:String(o.id)},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),a[15]||(a[15]=s("div",{style:{"font-size":"12px",color:"#909399","margin-top":"4px"}},"未指定游戏模型时使用此模型",-1))]),_:1}),e(j,{label:"游戏专用模型"},{default:l(()=>[s("div",Rl,[(c(!0),_(Q,null,X(K.value,o=>(c(),_("div",{key:o.game_id,class:"game-model-item"},[s("div",Ol,[s("span",Gl,A(o.name),1),e(ie,{size:"small",type:"info"},{default:l(()=>[g(A(o.game_id),1)]),_:2},1024)]),e(ae,{modelValue:T.value.gameModels[o.game_id],"onUpdate:modelValue":W=>T.value.gameModels[o.game_id]=W,placeholder:"使用默认模型",clearable:"",style:{flex:"1","margin-left":"12px"}},{default:l(()=>[e(F,{label:"使用默认模型",value:""}),(c(!0),_(Q,null,X(G.value,W=>(c(),Y(F,{key:W.id,label:`${W.provider.name} / ${W.name}`,value:String(W.id)},null,8,["label","value"]))),128))]),_:1},8,["modelValue","onUpdate:modelValue"])]))),128)),!K.value||K.value.length===0?(c(),_("div",Nl," 暂无可用游戏 ")):B("",!0)])]),_:1})]),_:1})])]),e(ye),s("div",Fl,[s("div",jl,[a[17]||(a[17]=s("h3",null,"AI服务提供商",-1)),e(f,{type:"primary",onClick:a[1]||(a[1]=o=>$.value=!0)},{default:l(()=>[e(H,null,{default:l(()=>[e(x(ll))]),_:1}),a[16]||(a[16]=s("span",null,"添加提供商",-1))]),_:1})]),a[24]||(a[24]=el('<div class="info-box" data-v-5ccdccc7><h4 class="info-title" data-v-5ccdccc7>API配置说明</h4><div class="info-content" data-v-5ccdccc7><div data-v-5ccdccc7><strong data-v-5ccdccc7>OpenAI及兼容服务：</strong>API URL填写完整路径，如 <code class="bg-blue-100 px-1 rounded" data-v-5ccdccc7>https://api.openai.com/v1/chat/completions</code></div><div data-v-5ccdccc7><strong data-v-5ccdccc7>Anthropic Claude：</strong>API URL填写 <code class="bg-blue-100 px-1 rounded" data-v-5ccdccc7>https://api.anthropic.com/v1/messages</code></div><div data-v-5ccdccc7><strong data-v-5ccdccc7>Google Gemini：</strong>API URL填写 <code class="bg-blue-100 px-1 rounded" data-v-5ccdccc7>https://generativelanguage.googleapis.com/v1beta</code></div><div data-v-5ccdccc7><strong data-v-5ccdccc7>自定义提供商：</strong>大多数第三方服务使用OpenAI兼容格式</div></div></div>',1)),z.value.length===0?(c(),_("div",ql,[e(H,{style:{"font-size":"60px",color:"#dcdfe6","margin-bottom":"16px"}},{default:l(()=>[e(x(He))]),_:1}),a[18]||(a[18]=s("p",null,"还没有配置任何AI提供商",-1)),a[19]||(a[19]=s("p",{style:{"font-size":"14px","margin-top":"8px",color:"#909399"}},"点击上方按钮添加您的第一个AI服务",-1))])):(c(),_("div",Hl,[(c(!0),_(Q,null,X(z.value,o=>{var W;return c(),_("div",{key:o.id,class:"provider-card"},[s("div",Kl,[s("div",Jl,[e(me,{modelValue:o.enabled,"onUpdate:modelValue":V=>o.enabled=V,onChange:V=>se(o)},null,8,["modelValue","onUpdate:modelValue","onChange"]),s("h4",Wl,A(o.name),1),e(ie,{size:"small",type:J(o.type)},{default:l(()=>[g(A(N(o.type)),1)]),_:2},1032,["type"]),o.enabled&&o.api_key?(c(),Y(H,{key:0,style:{color:"#67c23a"},title:"已配置"},{default:l(()=>[e(x(tl))]),_:1})):B("",!0)]),s("div",Ql,[e(f,{size:"small",onClick:V=>O(o),title:"编辑提供商"},{default:l(()=>[e(H,null,{default:l(()=>[e(x(Le))]),_:1})]),_:1},8,["onClick"]),e(f,{size:"small",type:"danger",onClick:V=>be(o),title:"删除提供商"},{default:l(()=>[e(H,null,{default:l(()=>[e(x(Be))]),_:1})]),_:1},8,["onClick"])])]),s("div",Xl,[s("div",Yl,[a[20]||(a[20]=s("label",{class:"field-label"},"API密钥",-1)),e(te,{modelValue:o.api_key,"onUpdate:modelValue":V=>o.api_key=V,type:"password","show-password":"",placeholder:"输入API密钥",onInput:V=>_e(o)},null,8,["modelValue","onUpdate:modelValue","onInput"])]),s("div",Zl,[s("label",ea,[a[21]||(a[21]=g(" API URL ",-1)),o.type!=="custom"?(c(),_("span",la,"(可选)")):B("",!0)]),e(te,{modelValue:o.base_url,"onUpdate:modelValue":V=>o.base_url=V,type:"url",placeholder:ne(o.type),onInput:V=>_e(o)},null,8,["modelValue","onUpdate:modelValue","placeholder","onInput"])])]),s("div",null,[s("div",aa,[s("label",ta,"可用模型 ("+A(((W=o.models)==null?void 0:W.length)||0)+")",1),e(f,{size:"small",type:"primary",link:"",onClick:V=>he(o)},{default:l(()=>[...a[22]||(a[22]=[g(" 添加模型 ",-1)])]),_:1},8,["onClick"])]),s("div",sa,[!o.models||o.models.length===0?(c(),_("div",oa," 暂无模型 ")):B("",!0),(c(!0),_(Q,null,X(o.models,V=>(c(),_("div",{key:V.id,class:"model-item"},[s("div",na,[e(me,{modelValue:V.enabled,"onUpdate:modelValue":pe=>V.enabled=pe,onChange:pe=>ke(V)},null,8,["modelValue","onUpdate:modelValue","onChange"]),s("span",da,A(V.name),1),V.api_type?(c(),Y(ie,{key:0,size:"small",type:ce(V.api_type)},{default:l(()=>[g(A(de(V.api_type)),1)]),_:2},1032,["type"])):B("",!0)]),s("div",ra,[e(f,{size:"small",onClick:pe=>$e(o,V),loading:V.id===S.value},{default:l(()=>[...a[23]||(a[23]=[g(" 测试 ",-1)])]),_:1},8,["onClick","loading"]),e(f,{size:"small",onClick:pe=>ge(o,V)},{default:l(()=>[e(H,null,{default:l(()=>[e(x(Le))]),_:1})]),_:1},8,["onClick"]),e(f,{size:"small",type:"danger",onClick:pe=>Ve(o,V)},{default:l(()=>[e(H,null,{default:l(()=>[e(x(Be))]),_:1})]),_:1},8,["onClick"])])]))),128))])])])}),128))]))]),e(Ae,{modelValue:$.value,"onUpdate:modelValue":a[2]||(a[2]=o=>$.value=o),title:"选择提供商类型",width:"500px"},{default:l(()=>[s("div",ia,[(c(),_(Q,null,X(u,o=>s("div",{key:o.value,class:"provider-type-card",onClick:W=>n(o.value)},[s("h4",null,A(o.label),1),s("p",null,A(o.description),1)],8,ua)),64))])]),_:1},8,["modelValue"]),e(Ae,{modelValue:b.value,"onUpdate:modelValue":a[7]||(a[7]=o=>b.value=o),title:h.value?"编辑提供商":"添加提供商",width:"500px"},{footer:l(()=>[e(f,{onClick:a[6]||(a[6]=o=>b.value=!1)},{default:l(()=>[...a[26]||(a[26]=[g("取消",-1)])]),_:1}),e(f,{type:"primary",loading:P.value,onClick:fe},{default:l(()=>[g(A(h.value?"更新":"添加"),1)]),_:1},8,["loading"])]),default:l(()=>[e(p,{model:y.value,"label-width":"100px"},{default:l(()=>[e(j,{label:"类型"},{default:l(()=>[e(ie,null,{default:l(()=>[g(A(N(y.value.type)),1)]),_:1})]),_:1}),e(j,{label:"名称",required:""},{default:l(()=>[e(te,{modelValue:y.value.name,"onUpdate:modelValue":a[3]||(a[3]=o=>y.value.name=o),placeholder:"输入提供商名称"},null,8,["modelValue"])]),_:1}),e(j,{label:"API密钥",required:""},{default:l(()=>[e(te,{modelValue:y.value.api_key,"onUpdate:modelValue":a[4]||(a[4]=o=>y.value.api_key=o),type:"password","show-password":"",placeholder:"输入API密钥"},null,8,["modelValue"])]),_:1}),e(j,{label:"API URL"},{default:l(()=>[e(te,{modelValue:y.value.base_url,"onUpdate:modelValue":a[5]||(a[5]=o=>y.value.base_url=o),type:"url",placeholder:ne(y.value.type)},null,8,["modelValue","placeholder"]),a[25]||(a[25]=s("div",{style:{"font-size":"12px",color:"#909399","margin-top":"4px"}},"留空使用默认地址",-1))]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title"]),e(Ae,{modelValue:I.value,"onUpdate:modelValue":a[12]||(a[12]=o=>I.value=o),title:C.value?"编辑模型":"添加模型",width:"600px"},{footer:l(()=>[e(f,{onClick:le},{default:l(()=>[...a[28]||(a[28]=[g("取消",-1)])]),_:1}),e(f,{type:"primary",loading:P.value,onClick:Z},{default:l(()=>[g(A(C.value?"更新":"添加"),1)]),_:1},8,["loading"])]),default:l(()=>[e(p,{model:d.value,"label-width":"100px"},{default:l(()=>[e(j,{label:"API类型"},{default:l(()=>[e(ae,{modelValue:d.value.api_type,"onUpdate:modelValue":a[8]||(a[8]=o=>d.value.api_type=o),placeholder:"选择API类型",onChange:ee},{default:l(()=>[e(F,{label:"OpenAI",value:"openai"}),e(F,{label:"Anthropic",value:"anthropic"}),e(F,{label:"Google",value:"google"})]),_:1},8,["modelValue"])]),_:1}),e(j,{label:"模型ID",required:""},{default:l(()=>[e(te,{modelValue:d.value.model_id,"onUpdate:modelValue":a[9]||(a[9]=o=>d.value.model_id=o),placeholder:"如：gpt-4o"},null,8,["modelValue"])]),_:1}),e(j,{label:"显示名称",required:""},{default:l(()=>[e(te,{modelValue:d.value.name,"onUpdate:modelValue":a[10]||(a[10]=o=>d.value.name=o),placeholder:"如：GPT-4o"},null,8,["modelValue"])]),_:1}),e(j,{label:""},{default:l(()=>[e(f,{onClick:re,loading:R.value,type:"primary"},{default:l(()=>[e(H,null,{default:l(()=>[e(x(Je))]),_:1}),a[27]||(a[27]=g(" 获取模型列表 ",-1))]),_:1},8,["loading"]),E.value.length>0?(c(),_("span",ca," 已获取 "+A(E.value.length)+" 个模型 ",1)):B("",!0)]),_:1}),E.value.length>0?(c(),Y(j,{key:0,label:"搜索过滤"},{default:l(()=>[e(te,{modelValue:D.value,"onUpdate:modelValue":a[11]||(a[11]=o=>D.value=o),placeholder:"搜索模型（支持多关键词）",clearable:""},{prefix:l(()=>[e(H,null,{default:l(()=>[e(x(sl))]),_:1})]),_:1},8,["modelValue"])]),_:1})):B("",!0),E.value.length>0?(c(),Y(j,{key:1,label:"可用模型"},{default:l(()=>[s("div",ma,[(c(!0),_(Q,null,X(r.value,o=>(c(),_("div",{key:o,class:We(["model-select-item",{selected:d.value.model_id===o}]),onClick:W=>Pe(o)},A(o),11,pa))),128)),r.value.length===0?(c(),_("div",va," 没有匹配的模型 ")):B("",!0)])]),_:1})):B("",!0),U.value?(c(),Y(Xe,{key:2,type:"error",title:U.value,closable:!1,style:{"margin-bottom":"16px"}},null,8,["title"])):B("",!0)]),_:1},8,["model"])]),_:1},8,["modelValue","title"])])}}}),fa=ze(_a,[["__scopeId","data-v-5ccdccc7"]]);class Ie{static async chat(w){return await M.post("/admin/ai/chat",w)}static async chatStream(w,z,q,$){var b;try{const I=localStorage.getItem("token"),h=await fetch("https://game.252035.xyz/api/admin/ai/chat",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${I}`},body:JSON.stringify({...w,stream:!0})});if(!h.ok){const D=await h.text();throw new Error(`HTTP ${h.status}: ${D}`)}const C=(b=h.body)==null?void 0:b.getReader();if(!C)throw new Error("无法获取响应流");const k=new TextDecoder;let R="",E=0;for(;;){const{done:D,value:U}=await C.read();if(D){$();break}const S=k.decode(U,{stream:!0});R+=S;const K=R.split(`
`);R=K.pop()||"";for(const T of K)if(T.trim()&&!T.startsWith("event:")&&T.startsWith("data:")){const L=T.slice(5).trim();if(!L)continue;try{const G=JSON.parse(L);if(G.content!==void 0&&G.content!==""&&(E++,z(G.content)),G.done){$();return}}catch(G){console.error("[AIService] 解析SSE数据失败:",G,L)}}}}catch(I){console.error("[AIService] chatStream错误:",I),q(I)}}static async testConnection(w){return await M.post("/admin/ai/test",w)}}const ga=Object.freeze(Object.defineProperty({__proto__:null,AIService:Ie},Symbol.toStringTag,{value:"Module"})),ya={class:"playground"},wa={class:"playground-container"},ba={class:"chat-panel"},ha={class:"config-bar"},ka={style:{display:"flex","align-items":"center",gap:"8px"}},Va={class:"message-role"},$a=["innerHTML"],Pa={key:0,class:"message message-assistant"},Ca={class:"input-container"},Ma={class:"input-actions"},Aa=Ue({__name:"Playground",setup(ve){const w=De(),z=m([]),q=m([]),$=m(null),b=m(""),I=m(!0),P=m([]),h=m(""),C=m(!1),k=m(!1),R=m(),E=ue(()=>z.value.filter(u=>u.enabled)),D=ue(()=>$.value?q.value.filter(u=>u.provider_id===$.value&&u.enabled):[]),U=u=>{try{const r=Tl(u,{breaks:!0,gfm:!0});return typeof r=="string"?r:String(r)}catch{return u.replace(/\n/g,"<br>")}},S=()=>{b.value="",T()},K=async()=>{try{z.value=await w.getProviders()}catch(u){v.error("加载提供商失败: "+u.message)}},T=async()=>{if($.value)try{q.value=await w.getModels($.value)}catch(u){v.error("加载模型失败: "+u.message)}},L=()=>{dl(()=>{R.value&&(R.value.scrollTop=R.value.scrollHeight)})},G=u=>{u.ctrlKey&&u.key==="Enter"&&(u.preventDefault(),y())},y=async()=>{if(!h.value.trim()||!b.value||!$.value)return;const u={role:"user",content:h.value.trim()};P.value.push(u),h.value="",L();try{if(I.value){k.value=!0,L();let r="",N=-1;await Ie.chatStream({provider_id:$.value,model_id:b.value,messages:P.value,stream:!0},J=>{N===-1&&(k.value=!1,P.value.push({role:"assistant",content:""}),N=P.value.length-1),r+=J,P.value[N].content=r,L()},J=>{console.error("[Playground] onError 被调用:",J),k.value=!1,C.value=!1,v.error("对话失败: "+J.message)},()=>{k.value=!1,C.value=!1,L()})}else{C.value=!0;const r=await Ie.chat({provider_id:$.value,model_id:b.value,messages:P.value,stream:!1});P.value.push({role:"assistant",content:r.content}),C.value=!1,L()}}catch(r){C.value=!1,k.value=!1,v.error("发送消息失败: "+r.message)}},d=()=>{P.value=[]};return Ee(()=>{K()}),(u,r)=>{const N=Fe,J=Ne,ne=Qe,de=Se,ce=Te;return c(),_("div",ya,[r[10]||(r[10]=s("div",{class:"playground-header"},[s("h2",null,"AI 操练场"),s("p",{class:"header-desc"},"选择提供商和模型进行对话测试")],-1)),s("div",wa,[s("div",ba,[s("div",ha,[e(J,{modelValue:$.value,"onUpdate:modelValue":r[0]||(r[0]=i=>$.value=i),placeholder:"选择提供商",onChange:S,style:{width:"200px"},size:"small"},{default:l(()=>[(c(!0),_(Q,null,X(E.value,i=>(c(),Y(N,{key:i.id,label:i.name,value:i.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),e(J,{modelValue:b.value,"onUpdate:modelValue":r[1]||(r[1]=i=>b.value=i),placeholder:"选择模型",disabled:!$.value,style:{width:"250px"},size:"small"},{default:l(()=>[(c(!0),_(Q,null,X(D.value,i=>(c(),Y(N,{key:i.id,label:i.name,value:i.model_id},null,8,["label","value"]))),128))]),_:1},8,["modelValue","disabled"]),s("div",ka,[r[4]||(r[4]=s("span",{style:{"font-size":"14px",color:"#666"}},"流式输出",-1)),e(ne,{modelValue:I.value,"onUpdate:modelValue":r[2]||(r[2]=i=>I.value=i),size:"small"},null,8,["modelValue"])]),r[6]||(r[6]=s("div",{style:{flex:"1"}},null,-1)),e(de,{size:"small",onClick:d,disabled:P.value.length===0},{default:l(()=>[...r[5]||(r[5]=[g(" 清空对话 ",-1)])]),_:1},8,["disabled"])]),s("div",{class:"messages-container",ref_key:"messagesContainer",ref:R},[(c(!0),_(Q,null,X(P.value,(i,n)=>(c(),_("div",{key:n,class:We(["message",`message-${i.role}`])},[s("div",Va,A(i.role==="user"?"用户":"AI"),1),s("div",{class:"message-content",innerHTML:U(i.content)},null,8,$a)],2))),128)),k.value?(c(),_("div",Pa,[...r[7]||(r[7]=[s("div",{class:"message-role"},"AI",-1),s("div",{class:"message-content typing-indicator"},[s("span"),s("span"),s("span")],-1)])])):B("",!0)],512),s("div",Ca,[e(ce,{modelValue:h.value,"onUpdate:modelValue":r[3]||(r[3]=i=>h.value=i),type:"textarea",rows:3,placeholder:"输入消息... (Ctrl+Enter 发送)",onKeydown:G,disabled:C.value||!b.value},null,8,["modelValue","disabled"]),s("div",Ma,[r[9]||(r[9]=s("span",{class:"input-hint"},"Ctrl + Enter 发送",-1)),e(de,{type:"primary",onClick:y,loading:C.value,disabled:!h.value.trim()||!b.value},{default:l(()=>[...r[8]||(r[8]=[g(" 发送 ",-1)])]),_:1},8,["loading","disabled"])])])])])])}}}),xa=ze(Aa,[["__scopeId","data-v-362b6de1"]]),Ia={class:"admin-container"},Ua={class:"header-content"},Ea={class:"breadcrumb"},Sa={class:"user-info"},Ta={class:"el-dropdown-link"},za={key:0,class:"overview-content"},Da={class:"stats-item"},La={class:"stats-number"},Ba={class:"stats-item"},Ra={class:"stats-number"},Oa={class:"stats-item"},Ga={class:"stats-number"},Na={key:1},Fa={class:"card-header"},ja={key:2},qa={key:3},Ha={key:4},Ka={class:"dialog-footer"},Ja=Ue({__name:"AdminView",setup(ve){const w=il(),z=rl(),q=De(),$=m(!1),b=m([]),I=m(!1),P=m(!1),h=m(null),C=m(),k=m("overview"),R=ue(()=>b.value.length),E=ue(()=>b.value.filter(i=>i.is_admin).length),D=m(0),U=xe({siteName:"AI Game Engine",siteDescription:"一个基于AI的文字冒险游戏引擎",allowRegister:!0}),S=xe({newPassword:"",confirmPassword:""}),T=xe({newPassword:[{required:!0,message:"请输入新密码",trigger:"blur"},{min:6,message:"密码长度不能少于 6 位",trigger:"blur"}],confirmPassword:[{required:!0,message:"请确认密码",trigger:"blur"},{validator:(i,n,O)=>{n!==S.newPassword?O(new Error("两次输入密码不一致")):O()},trigger:"blur"}]});Ee(()=>{if(!z.isAdmin()){w.push("/chat");return}y()});const L=i=>{k.value=i,i==="users"&&y()},G=()=>({overview:"概览",users:"用户管理",providers:"提供商管理",playground:"操练场",system:"系统设置"})[k.value]||"概览",y=async()=>{$.value=!0;try{b.value=await q.getUsers()}catch(i){console.error("获取用户列表失败:",i)}finally{$.value=!1}},d=()=>{y()},u=i=>{h.value=i,S.newPassword="",S.confirmPassword="",I.value=!0},r=async()=>{if(!(!C.value||!h.value))try{if(!await C.value.validate())return;P.value=!0,await q.updateUserPassword(h.value.id,S.newPassword),v.success("密码修改成功"),I.value=!1}catch(i){console.error("密码修改失败:",i)}finally{P.value=!1}},N=async i=>{try{await we.confirm(`确定要${i.is_admin?"取消":"设置"}用户 "${i.username}" 的管理员权限吗？`,"确认操作",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),await q.toggleUserAdmin(i.id),v.success("权限修改成功"),await y()}catch(n){n!=="cancel"&&console.error("权限修改失败:",n)}},J=async i=>{try{await we.confirm(`确定要删除用户 "${i.username}" 吗？此操作不可恢复！`,"确认删除",{confirmButtonText:"删除",cancelButtonText:"取消",type:"warning"}),await q.deleteUser(i.id),v.success("用户删除成功"),await y()}catch(n){n!=="cancel"&&console.error("用户删除失败:",n)}},ne=()=>{z.logout()},de=()=>{w.push("/chat")},ce=()=>{v.success("系统设置已保存")};return(i,n)=>{const O=qe,se=pl,_e=ml,be=cl,fe=wl,he=yl,ge=$l,ke=Vl,Ve=bl,$e=gl,ee=xl,re=Al,Pe=Ml,Z=Se,le=El,Ce=je,Me=Sl,oe=Te,t=Ge,a=Qe,f=Oe,F=Cl,ae=ul,j=Ke,ie=Ul;return c(),_("div",Ia,[e(ae,{style:{height:"100vh"}},{default:l(()=>[e(be,{width:"250px",class:"admin-sidebar"},{default:l(()=>[n[12]||(n[12]=s("div",{class:"logo"},[s("h3",null,"管理后台")],-1)),e(_e,{"default-active":k.value,class:"admin-menu","background-color":"#001529","text-color":"#ffffff","active-text-color":"#1890ff",onSelect:L},{default:l(()=>[e(se,{index:"overview"},{default:l(()=>[e(O,null,{default:l(()=>[e(x(vl))]),_:1}),n[7]||(n[7]=s("span",null,"概览",-1))]),_:1}),e(se,{index:"users"},{default:l(()=>[e(O,null,{default:l(()=>[e(x(_l))]),_:1}),n[8]||(n[8]=s("span",null,"用户管理",-1))]),_:1}),e(se,{index:"providers"},{default:l(()=>[e(O,null,{default:l(()=>[e(x(fl))]),_:1}),n[9]||(n[9]=s("span",null,"提供商管理",-1))]),_:1}),e(se,{index:"playground"},{default:l(()=>[e(O,null,{default:l(()=>[e(x(Re))]),_:1}),n[10]||(n[10]=s("span",null,"操练场",-1))]),_:1}),e(se,{index:"system"},{default:l(()=>[e(O,null,{default:l(()=>[e(x(He))]),_:1}),n[11]||(n[11]=s("span",null,"系统设置",-1))]),_:1})]),_:1},8,["default-active"])]),_:1}),e(ae,null,{default:l(()=>[e($e,{class:"admin-header"},{default:l(()=>[s("div",Ua,[s("div",Ea,[e(he,{separator:"/"},{default:l(()=>[e(fe,null,{default:l(()=>[...n[13]||(n[13]=[g("管理后台",-1)])]),_:1}),e(fe,null,{default:l(()=>[g(A(G()),1)]),_:1})]),_:1})]),s("div",Sa,[e(Ve,null,{dropdown:l(()=>[e(ke,null,{default:l(()=>[e(ge,{onClick:de},{default:l(()=>[e(O,null,{default:l(()=>[e(x(Re))]),_:1}),n[14]||(n[14]=g(" 返回主页 ",-1))]),_:1}),e(ge,{divided:"",onClick:ne},{default:l(()=>[e(O,null,{default:l(()=>[e(x(Pl))]),_:1}),n[15]||(n[15]=g(" 退出登录 ",-1))]),_:1})]),_:1})]),default:l(()=>{var p;return[s("span",Ta,[e(O,null,{default:l(()=>[e(x(hl))]),_:1}),g(" "+A((p=x(z).user)==null?void 0:p.username)+" ",1),e(O,{class:"el-icon--right"},{default:l(()=>[e(x(kl))]),_:1})])]}),_:1})])])]),_:1}),e(F,{class:"admin-main"},{default:l(()=>[k.value==="overview"?(c(),_("div",za,[e(Pe,{gutter:20},{default:l(()=>[e(re,{span:6},{default:l(()=>[e(ee,{class:"stats-card"},{default:l(()=>[s("div",Da,[s("div",La,A(R.value),1),n[16]||(n[16]=s("div",{class:"stats-label"},"总用户数",-1))])]),_:1})]),_:1}),e(re,{span:6},{default:l(()=>[e(ee,{class:"stats-card"},{default:l(()=>[s("div",Ba,[s("div",Ra,A(E.value),1),n[17]||(n[17]=s("div",{class:"stats-label"},"管理员数",-1))])]),_:1})]),_:1}),e(re,{span:6},{default:l(()=>[e(ee,{class:"stats-card"},{default:l(()=>[s("div",Oa,[s("div",Ga,A(D.value),1),n[18]||(n[18]=s("div",{class:"stats-label"},"对话总数",-1))])]),_:1})]),_:1}),e(re,{span:6},{default:l(()=>[e(ee,{class:"stats-card"},{default:l(()=>[...n[19]||(n[19]=[s("div",{class:"stats-item"},[s("div",{class:"stats-number"},"Online"),s("div",{class:"stats-label"},"系统状态")],-1)])]),_:1})]),_:1})]),_:1})])):B("",!0),k.value==="users"?(c(),_("div",Na,[e(ee,null,{header:l(()=>[s("div",Fa,[n[21]||(n[21]=s("span",null,"用户管理",-1)),e(Z,{type:"primary",onClick:d},{default:l(()=>[e(O,null,{default:l(()=>[e(x(Je))]),_:1}),n[20]||(n[20]=g(" 刷新 ",-1))]),_:1})])]),default:l(()=>[Il((c(),Y(Me,{data:b.value,style:{width:"100%"}},{default:l(()=>[e(le,{prop:"id",label:"ID",width:"80"}),e(le,{prop:"username",label:"用户名"}),e(le,{prop:"email",label:"邮箱"}),e(le,{prop:"is_admin",label:"管理员",width:"100"},{default:l(p=>[e(Ce,{type:p.row.is_admin?"success":"info"},{default:l(()=>[g(A(p.row.is_admin?"是":"否"),1)]),_:2},1032,["type"])]),_:1}),e(le,{label:"操作",width:"300"},{default:l(p=>{var ye,H;return[e(Z,{size:"small",onClick:me=>u(p.row)},{default:l(()=>[...n[22]||(n[22]=[g(" 修改密码 ",-1)])]),_:1},8,["onClick"]),e(Z,{size:"small",type:"warning",onClick:me=>N(p.row),disabled:p.row.id===((ye=x(z).user)==null?void 0:ye.id)},{default:l(()=>[g(A(p.row.is_admin?"取消管理员":"设为管理员"),1)]),_:2},1032,["onClick","disabled"]),e(Z,{size:"small",type:"danger",onClick:me=>J(p.row),disabled:p.row.id===((H=x(z).user)==null?void 0:H.id)},{default:l(()=>[...n[23]||(n[23]=[g(" 删除 ",-1)])]),_:1},8,["onClick","disabled"])]}),_:1})]),_:1},8,["data"])),[[ie,$.value]])]),_:1})])):B("",!0),k.value==="providers"?(c(),_("div",ja,[e(fa)])):B("",!0),k.value==="playground"?(c(),_("div",qa,[e(xa)])):B("",!0),k.value==="system"?(c(),_("div",Ha,[e(ee,null,{header:l(()=>[...n[24]||(n[24]=[s("span",null,"系统设置",-1)])]),default:l(()=>[e(f,{"label-width":"120px"},{default:l(()=>[e(t,{label:"系统名称"},{default:l(()=>[e(oe,{modelValue:U.siteName,"onUpdate:modelValue":n[0]||(n[0]=p=>U.siteName=p),placeholder:"AI Chat System"},null,8,["modelValue"])]),_:1}),e(t,{label:"系统描述"},{default:l(()=>[e(oe,{type:"textarea",modelValue:U.siteDescription,"onUpdate:modelValue":n[1]||(n[1]=p=>U.siteDescription=p),placeholder:"一个基于AI的智能对话系统",rows:3},null,8,["modelValue"])]),_:1}),e(t,{label:"允许注册"},{default:l(()=>[e(a,{modelValue:U.allowRegister,"onUpdate:modelValue":n[2]||(n[2]=p=>U.allowRegister=p)},null,8,["modelValue"])]),_:1}),e(t,null,{default:l(()=>[e(Z,{type:"primary",onClick:ce},{default:l(()=>[...n[25]||(n[25]=[g("保存设置",-1)])]),_:1})]),_:1})]),_:1})]),_:1})])):B("",!0)]),_:1})]),_:1})]),_:1}),e(j,{modelValue:I.value,"onUpdate:modelValue":n[6]||(n[6]=p=>I.value=p),title:"修改用户密码",width:"400px"},{footer:l(()=>[s("div",Ka,[e(Z,{onClick:n[5]||(n[5]=p=>I.value=!1)},{default:l(()=>[...n[26]||(n[26]=[g("取消",-1)])]),_:1}),e(Z,{type:"primary",onClick:r,loading:P.value},{default:l(()=>[...n[27]||(n[27]=[g(" 确认 ",-1)])]),_:1},8,["loading"])])]),default:l(()=>[e(f,{model:S,rules:T,ref_key:"passwordFormRef",ref:C},{default:l(()=>[e(t,{label:"用户名"},{default:l(()=>{var p;return[e(oe,{value:(p=h.value)==null?void 0:p.username,disabled:""},null,8,["value"])]}),_:1}),e(t,{label:"新密码",prop:"newPassword"},{default:l(()=>[e(oe,{modelValue:S.newPassword,"onUpdate:modelValue":n[3]||(n[3]=p=>S.newPassword=p),type:"password",placeholder:"请输入新密码","show-password":""},null,8,["modelValue"])]),_:1}),e(t,{label:"确认密码",prop:"confirmPassword"},{default:l(()=>[e(oe,{modelValue:S.confirmPassword,"onUpdate:modelValue":n[4]||(n[4]=p=>S.confirmPassword=p),type:"password",placeholder:"请确认新密码","show-password":""},null,8,["modelValue"])]),_:1})]),_:1},8,["model","rules"])]),_:1},8,["modelValue"])])}}}),Za=ze(Ja,[["__scopeId","data-v-efdc43a2"]]);export{Za as default};
