import{d as $e,u as ke,r as c,p as P,q as we,s as je,c as d,h as N,m as n,F,v as Q,t as v,l as Ae,x as Se,y as Oe,z as xe,A as le,n as f,e as Te,B as j,o as u}from"./index-DxKlfA5R.js";import{k as Ce}from"./marked.esm-z4go5P_g.js";import{_ as Ve}from"./_plugin-vue_export-helper-DlAUqK2U.js";const Ge={class:"game-container"},Me={key:0,class:"game-selection"},We={class:"game-list"},Ne=["onClick"],Be={class:"game-card-footer"},Ee={class:"version"},Re={class:"author"},Ie={key:1,class:"game-play"},Le={class:"game-header"},ze={class:"game-title"},He={class:"mod-id"},Pe={class:"game-actions"},Je={class:"opportunities"},Ke=["disabled"],Ue={class:"game-content"},qe={class:"status-panel"},Fe={class:"panel-content"},Qe={key:0,class:"character-status"},Xe={class:"status-key"},Ye=["innerHTML"],Ze={key:1,class:"no-character"},De={class:"game-main"},es=["innerHTML"],ss={class:"input-area"},ts=["disabled"],as={key:1,class:"action-input-row"},is=["disabled"],ns=["disabled"],ls={key:2,class:"success-message"},os={key:2,class:"roll-overlay"},rs={class:"roll-panel"},cs={class:"roll-details"},ds={class:"roll-type"},us={key:0,class:"roll-target"},vs={key:0,class:"roll-result-display"},fs={class:"roll-value"},ps={key:3,class:"loading-overlay"},ys={class:"loading-spinner"},hs={class:"loading-text"},gs=$e({__name:"GameView",setup(_s){const X=Te(),m=ke(),J=c([]),y=c(""),Y=c(null),i=c(null),oe=P(()=>{var e;return((e=i.value)==null?void 0:e.display_history)||[]}),b=P(()=>{var e;return((e=i.value)==null?void 0:e.state)||i.value||{}}),Z=P(()=>{var t;const e=(t=b.value)==null?void 0:t.current_life;if(!e||typeof e!="object")return null;const s={};for(const[a,l]of Object.entries(e))if(l!=null&&l!==""&&l!==0){if(Array.isArray(l)&&l.length===0||typeof l=="object"&&!Array.isArray(l)&&Object.keys(l).length===0)continue;s[a]=l}return Object.keys(s).length>0?s:null}),A=c(""),B=P(()=>{var e;return((e=b.value)==null?void 0:e.is_processing)||!1}),g=c(!1),S=c("加载中..."),K=c(!1),h=c(null),O=c(!1),E=c(!1);let r=null;const $=c(!1),x=c(!0),R=c();async function D(){try{g.value=!0;const e=await fetch("/api/game/mods",{headers:{Authorization:`Bearer ${m.token}`}});e.ok?J.value=await e.json():f.error("加载游戏列表失败")}catch(e){console.error("加载mod列表失败:",e),f.error("网络错误")}finally{g.value=!1}}async function re(e){x.value=!0,y.value=e,Y.value=J.value.find(s=>s.game_id===e),await ce()}async function ce(){try{g.value=!0,S.value="正在初始化游戏...";const e=await fetch("/api/game/init",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${m.token}`},body:JSON.stringify({mod_id:y.value})});if(e.ok){S.value="正在加载游戏数据...";const s=await e.json();i.value=s.state||s,S.value="正在建立实时连接...",ee()}else{const s=await e.text();console.error("[GameView] 初始化失败:",s),f.error("初始化游戏失败: "+s)}}catch(e){console.error("初始化游戏失败:",e),f.error("网络错误")}finally{g.value=!1}}function ee(){const s=`${window.location.protocol==="https:"?"wss:":"ws:"}//${window.location.host}/api/game/ws?mod_id=${y.value}&token=${m.token}`;r=new WebSocket(s),r.onopen=()=>{$.value=!0,g.value=!1,f.success("连接成功")},r.onmessage=t=>{try{const a=JSON.parse(t.data);de(a)}catch(a){console.error("[GameView] 解析WebSocket消息失败:",a)}},r.onerror=t=>{console.error("[GameView] ❌ WebSocket错误:",t),$.value=!1,f.error("连接错误")},r.onclose=t=>{$.value=!1,x.value&&y.value&&m.token&&setTimeout(()=>{ee()},3e3)}}const T=c(""),I=c(!1),k=c(null),C=c(""),L=c(!1);function de(e){var s;switch(g.value=!1,e.type){case"narrative_chunk":I.value||(I.value=!0,T.value="",i.value&&i.value.display_history&&(i.value.display_history=[...i.value.display_history,T.value])),T.value+=e.data.content;let t=T.value;const a=t.indexOf("```json");a>=0&&(t=t.substring(0,a).trim());const l=t.indexOf("```");l>=0&&(t=t.substring(0,l).trim());const o=t.match(/【判定结果：(成功|失败)】/);if(o&&!k.value){k.value=t,se(o[1]==="成功");return}if(i.value&&i.value.display_history){const V=i.value.display_history.length-1;i.value.display_history=[...i.value.display_history.slice(0,V),t]}j(()=>w());break;case"full_state":I.value=!1,L.value=!1,O.value=!1;const H=((s=i.value)==null?void 0:s.display_history)||[];i.value={...e.data,display_history:H},T.value="",C.value="",k.value=null,j(()=>w());break;case"roll_event":O.value=!0,se(e.data.success,e.data);break;case"roll_result":i.value&&i.value.display_history&&(i.value.display_history=[...i.value.display_history,e.data.content],j(()=>w()));break;case"second_stage_narrative":L.value||(L.value=!0,C.value="",i.value&&i.value.display_history&&(i.value.display_history=[...i.value.display_history,C.value])),C.value+=e.data.content;let _=C.value;const G=_.indexOf("```json");G>=0&&(_=_.substring(0,G).trim());const M=_.indexOf("```");if(M>=0&&(_=_.substring(0,M).trim()),i.value&&i.value.display_history){const V=i.value.display_history.length-1;i.value.display_history=[...i.value.display_history.slice(0,V),_],j(()=>w())}break;case"error":I.value=!1,L.value=!1,T.value="",C.value="",k.value=null,f.error(e.detail||"发生错误");break}}function se(e,s){K.value=!0,s?h.value={type:s.type||"天道裁决",target:s.target,description:s.description||"判定中...",result:s.result,success:e,outcome:s.outcome}:h.value={description:"判定中...",success:e},setTimeout(()=>{h.value&&(h.value.description=(s==null?void 0:s.description)||(e?"判定成功！":"判定失败！"))},1500),setTimeout(()=>{if(K.value=!1,h.value=null,k.value&&i.value){const t=i.value.display_history.length-1;i.value.display_history=[...i.value.display_history.slice(0,t),k.value],j(()=>w())}k.value=null},3e3)}async function ue(){if(!r||r.readyState!==WebSocket.OPEN){console.error("[GameView] WebSocket未连接"),f.error("连接未就绪，请稍候重试");return}i.value&&i.value.state&&(i.value.state.is_processing=!0),i.value&&i.value.display_history&&(i.value.display_history=[...i.value.display_history,"> 开始试炼"],j(()=>w())),g.value=!0,S.value="正在开启试炼...",r.send(JSON.stringify({action:"start_trial"}))}function te(){if(A.value.trim()&&r&&r.readyState===WebSocket.OPEN){const e=A.value.trim();i.value&&i.value.state&&(i.value.state.is_processing=!0),i.value&&i.value.display_history&&(i.value.display_history=[...i.value.display_history,`> ${e}`],j(()=>w())),r.send(JSON.stringify({action:e})),A.value=""}}async function U(){if(y.value){E.value=!0;try{const e=await fetch("/api/game/save",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${m.token}`},body:JSON.stringify({mod_id:y.value})});if(e.ok)f.success("存档成功");else{const s=await e.text();console.error("[GameView] 存档失败:",s),f.error("存档失败")}}catch(e){console.error("[GameView] 存档异常:",e),f.error("存档异常")}finally{E.value=!1}}}function ve(){confirm(`⚠️ 确定要重启机缘吗？

这将会：
• 清空所有存档数据
• 重置机缘次数为10次
• 无法恢复已删除的数据

确认继续？`)&&fe()}async function fe(){var e;try{g.value=!0,S.value="正在重启机缘...";const s=await fetch("/api/game/restart-opportunities",{method:"POST",headers:{Authorization:`Bearer ${m.token}`,"Content-Type":"application/json"}});if(s.ok){const t=await s.json();x.value=!1,r&&(r.close(),r=null),$.value=!1,y.value="",i.value=null,await D(),f.success(`机缘已重启！删除了 ${t.deleted_saves} 条存档`)}else{const t=await s.text();console.error("[GameView] 重启机缘失败 - 状态码:",s.status),console.error("[GameView] 重启机缘失败 - 响应:",t),console.error("[GameView] 重启机缘失败 - token长度:",((e=m.token)==null?void 0:e.length)||0),s.status===401?(f.error("认证失败，请重新登录"),m.logout(),X.push("/login")):f.error("重启机缘失败: "+t)}}catch(s){console.error("重启机缘失败:",s),f.error("网络错误")}finally{g.value=!1}}async function pe(){x.value=!1,y.value&&await U(),r&&(r.close(),r=null),$.value=!1,y.value="",i.value=null}async function ye(){x.value=!1,y.value&&await U(),r&&(r.close(),r=null),m.logout(),X.push("/login")}function he(e){try{let s=e.replace(/\\n/g,`
`);return Ce.parse(s,{breaks:!0,gfm:!0})}catch{return e.replace(/\\n/g,"<br>").replace(/\n/g,"<br>")}}function ge(e){return e.startsWith("> ")?"user-message":e.startsWith("【判定结果：")?"roll-result-message":e.startsWith("【")?"system-message":"narrative-message"}function z(e){const s=[{pattern:/^(姓名|名称|角色)$/i,icon:"🧙‍♂️"},{pattern:/^(修为|经验|exp)$/i,icon:"⚡"},{pattern:/^(境界|等级|level|阶位)$/i,icon:"🏔️"},{pattern:/^(生命|血量|hp|health)$/i,icon:"❤️"},{pattern:/^(寿元|寿命|年龄|age)$/i,icon:"⏳"},{pattern:/^(灵石|金币|货币|money|gold)$/i,icon:"💎"},{pattern:/^(位置|地点|location)$/i,icon:"📍"},{pattern:/^(出身|背景|origin)$/i,icon:"🏡"},{pattern:/^(天赋|才能|talent)$/i,icon:"⭐"},{pattern:/^(灵根|资质|根骨)$/i,icon:"🌿"},{pattern:/^(属性|状态|stats)$/i,icon:"📊"},{pattern:/^(功法|技能|skill)$/i,icon:"📚"},{pattern:/^(物品|道具|背包|inventory)$/i,icon:"🎒"},{pattern:/^(状态|效果|buff|debuff)$/i,icon:"💫"},{pattern:/^(事件|历史|故事|history)$/i,icon:"📜"},{pattern:/^(目标|任务|quest)$/i,icon:"🎯"},{pattern:/^(关系|人际|社交)$/i,icon:"👥"},{pattern:/^(药园|农场|种植)$/i,icon:"🌱"},{pattern:/^(悟性|智力|intelligence)$/i,icon:"🧠"},{pattern:/^(气运|运气|luck)$/i,icon:"🍀"},{pattern:/^(声望|名望|reputation)$/i,icon:"⭐"}];for(const t of s)if(t.pattern.test(e))return`${t.icon} ${e}`;return`📋 ${e}`}function q(e){if(e==null)return'<span class="empty-value">无</span>';if(typeof e=="string")return e;if(typeof e=="number")return e.toString();if(Array.isArray(e))return e.length===0?'<span class="empty-value">无</span>':e.map(s=>typeof s=="string"?`<div class="array-item">• ${s}</div>`:typeof s=="object"&&s!==null?s.名称&&s.数量?`<div class="item-entry">• ${s.名称} × ${s.数量}${s.说明?`<br><span class="item-desc">${s.说明}</span>`:""}</div>`:`<div class="array-item">• ${ie(s)}</div>`:`<div class="array-item">• ${s}</div>`).join("");if(typeof e=="object"){if(e.人生目标||e.立即目标||e.阶段目标){let s='<div class="goal-system-container">';return e.人生目标&&(s+='<div class="goal-section goal-life">',s+='<div class="goal-section-title">🌟 人生目标</div>',s+='<div class="goal-section-content">',e.人生目标.描述&&(s+=`<div class="goal-field"><span class="field-label">描述：</span>${e.人生目标.描述}</div>`),e.人生目标.核心动机&&(s+=`<div class="goal-field"><span class="field-label">核心动机：</span>${e.人生目标.核心动机}</div>`),e.人生目标.最终愿景&&(s+=`<div class="goal-field"><span class="field-label">最终愿景：</span>${e.人生目标.最终愿景}</div>`),e.人生目标.宿命纠葛&&Array.isArray(e.人生目标.宿命纠葛)&&e.人生目标.宿命纠葛.length>0&&(s+=`<div class="goal-field"><span class="field-label">宿命纠葛：</span><div class="field-list">${e.人生目标.宿命纠葛.map(t=>`<div class="list-item">• ${t}</div>`).join("")}</div></div>`),s+="</div></div>"),e.立即目标&&(s+='<div class="goal-section goal-immediate">',s+='<div class="goal-section-title">⚡ 立即目标</div>',s+='<div class="goal-section-content">',e.立即目标.描述&&(s+=`<div class="goal-field"><span class="field-label">描述：</span>${e.立即目标.描述}</div>`),e.立即目标.紧迫程度&&(s+=`<div class="goal-field"><span class="field-label">紧迫程度：</span><span class="urgency-badge urgency-${e.立即目标.紧迫程度}">${e.立即目标.紧迫程度}</span></div>`),e.立即目标.完成条件&&(s+=`<div class="goal-field"><span class="field-label">完成条件：</span>${e.立即目标.完成条件}</div>`),e.立即目标.奖励预期&&(s+=`<div class="goal-field"><span class="field-label">奖励预期：</span>${e.立即目标.奖励预期}</div>`),s+="</div></div>"),e.阶段目标&&(s+='<div class="goal-section goal-stage">',s+='<div class="goal-section-title">📈 阶段目标</div>',s+='<div class="goal-section-content">',e.阶段目标.描述&&(s+=`<div class="goal-field"><span class="field-label">描述：</span>${e.阶段目标.描述}</div>`),e.阶段目标.关键节点&&Array.isArray(e.阶段目标.关键节点)&&e.阶段目标.关键节点.length>0&&(s+=`<div class="goal-field"><span class="field-label">关键节点：</span><div class="field-list">${e.阶段目标.关键节点.map(t=>`<div class="list-item">• ${t}</div>`).join("")}</div></div>`),e.阶段目标.障碍分析&&(s+=`<div class="goal-field"><span class="field-label">障碍分析：</span>${e.阶段目标.障碍分析}</div>`),e.阶段目标.解决路径&&(s+=`<div class="goal-field"><span class="field-label">解决路径：</span>${e.阶段目标.解决路径}</div>`),s+="</div></div>"),s+="</div>",s}return e.姓名||e.境界||e.修为||e.灵根?_e(e):ae(e)}return String(e)}function _e(e){let s='<div class="attributes-expanded">';const t=["姓名","出身","灵根","境界","寿元","生命值","修为","灵石","根骨","悟性","气运","初始天赋","功法","神通","物品","状态效果","关系网","声望","特殊标记","灵兽","道侣","洞府","药园"];return t.forEach(a=>{e[a]!==void 0&&e[a]!==null&&e[a]!==""&&!(Array.isArray(e[a])&&e[a].length===0)&&!(typeof e[a]=="object"&&!Array.isArray(e[a])&&Object.keys(e[a]).length===0)&&(s+=`<div class="attr-sub-item">
        <div class="attr-sub-key">${z(a)}</div>
        <div class="attr-sub-value">${q(e[a])}</div>
      </div>`)}),Object.keys(e).forEach(a=>{!t.includes(a)&&e[a]!==void 0&&e[a]!==null&&e[a]!==""&&!(Array.isArray(e[a])&&e[a].length===0)&&!(typeof e[a]=="object"&&!Array.isArray(e[a])&&Object.keys(e[a]).length===0)&&(s+=`<div class="attr-sub-item">
        <div class="attr-sub-key">${z(a)}</div>
        <div class="attr-sub-value">${q(e[a])}</div>
      </div>`)}),s+="</div>",s}function ae(e,s=0){const t=Object.entries(e).filter(([l,o])=>!(o==null||o===""||Array.isArray(o)&&o.length===0||typeof o=="object"&&!Array.isArray(o)&&Object.keys(o).length===0));if(t.length===0)return'<span class="empty-value">无</span>';let a='<div class="object-expanded">';return t.forEach(([l,o])=>{a+='<div class="object-item">',a+=`<div class="object-key">${z(l)}</div>`,a+='<div class="object-value">',o==null?a+='<span class="empty-value">无</span>':typeof o=="string"||typeof o=="number"||typeof o=="boolean"?a+=String(o):Array.isArray(o)?a+=me(o,s+1):typeof o=="object"?a+=ae(o,s+1):a+=String(o),a+="</div>",a+="</div>"}),a+="</div>",a}function me(e,s=0){if(e.length===0)return'<span class="empty-value">无</span>';let t='<div class="array-container">';return e.forEach(a=>{t+='<div class="array-item-wrapper">',typeof a=="string"||typeof a=="number"||typeof a=="boolean"?t+=`<div class="array-item-simple">• ${a}</div>`:typeof a=="object"&&a!==null?(t+='<div class="array-item-object">',t+=ie(a),t+="</div>"):t+=`<div class="array-item-simple">• ${a}</div>`,t+="</div>"}),t+="</div>",t}function ie(e){const s=Object.entries(e);if(s.length===0)return'<span class="empty-value">无</span>';let t='<div class="inline-object">';return s.forEach(([a,l])=>{l==null||l===""||(t+='<div class="inline-item">',t+=`<span class="inline-key">${a}:</span> `,typeof l=="string"||typeof l=="number"||typeof l=="boolean"?t+=`<span class="inline-value">${l}</span>`:Array.isArray(l)?t+=`<span class="inline-value">[${l.length}项]</span>`:typeof l=="object"?t+='<span class="inline-value">{对象}</span>':t+=`<span class="inline-value">${l}</span>`,t+="</div>")}),t+="</div>",t}function be(){var s;if(!$.value)return"连接中...";const e=((s=b.value)==null?void 0:s.opportunities_remaining)??10;return e<=0?"机缘已尽":e===10?"开始第一次试炼":"开启下一次试炼"}function w(){R.value&&(R.value.scrollTop=R.value.scrollHeight)}return we(()=>{D()}),je(()=>{x.value=!1,r&&(r.close(),r=null),$.value=!1}),(e,s)=>{var t,a,l,o,H,_,G,M,V,ne;return u(),d("div",Ge,[y.value?(u(),d("div",Ie,[n("header",Le,[n("div",ze,[n("h2",null,v((t=Y.value)==null?void 0:t.name),1),n("span",He,v(y.value),1)]),n("div",Pe,[n("span",Je,[s[3]||(s[3]=Ae(" 剩余机缘: ",-1)),n("strong",null,v(((a=b.value)==null?void 0:a.opportunities_remaining)??10),1)]),n("button",{onClick:U,class:"btn-save",disabled:E.value},v(E.value?"存档中...":"💾 手动存档"),9,Ke),n("button",{onClick:ve,class:"btn-restart",title:"清空所有存档，重新开始"}," 🔄 重启机缘 "),n("button",{onClick:pe,class:"btn-secondary"},"切换游戏"),n("button",{onClick:ye,class:"btn-danger"},"退出")])]),n("div",Ue,[n("aside",qe,[s[5]||(s[5]=n("div",{class:"panel-header"},[n("h3",null,"角色状态")],-1)),n("div",Fe,[Z.value?(u(),d("div",Qe,[(u(!0),d(F,null,Q(Z.value,(p,W)=>(u(),d("div",{key:W,class:"status-item"},[n("div",Xe,v(z(W)),1),n("div",{class:"status-value",innerHTML:q(p)},null,8,Ye)]))),128))])):(u(),d("div",Ze,[...s[4]||(s[4]=[n("p",null,"尚未开始冒险",-1)])]))])]),n("main",De,[n("div",{class:"narrative-window",ref_key:"narrativeWindow",ref:R},[(u(!0),d(F,null,Q(oe.value,(p,W)=>(u(),d("div",{key:W,class:le(["narrative-block",ge(p)]),innerHTML:he(p)},null,10,es))),128))],512),n("footer",ss,[!((l=b.value)!=null&&l.is_in_trial)&&!((o=b.value)!=null&&o.daily_success_achieved)?(u(),d("button",{key:0,onClick:ue,disabled:!$.value||B.value||O.value||(((H=b.value)==null?void 0:H.opportunities_remaining)??0)<=0,class:"btn-start"},v(be()),9,ts)):(_=b.value)!=null&&_.is_in_trial?(u(),d("div",as,[Se(n("input",{"onUpdate:modelValue":s[0]||(s[0]=p=>A.value=p),type:"text",placeholder:"汝欲何为...",onKeydown:xe(te,["enter"]),disabled:B.value||O.value,class:"action-input"},null,40,is),[[Oe,A.value]]),n("button",{onClick:te,disabled:B.value||O.value||!A.value.trim(),class:"btn-primary"},v(B.value?"处理中...":O.value?"判定中...":"行动"),9,ns)])):(G=b.value)!=null&&G.daily_success_achieved?(u(),d("div",ls,[...s[6]||(s[6]=[n("p",null,"🎉 今日功德圆满！明日再来。",-1)])])):N("",!0)])])])])):(u(),d("div",Me,[s[2]||(s[2]=n("div",{class:"selection-header"},[n("h1",null,"选择你的冒险"),n("p",null,"在不同的世界中展开独一无二的旅程")],-1)),n("div",We,[(u(!0),d(F,null,Q(J.value,p=>(u(),d("div",{key:p.game_id,class:"game-card",onClick:W=>re(p.game_id)},[s[1]||(s[1]=n("div",{class:"game-card-icon"},"🎮",-1)),n("h3",null,v(p.name),1),n("p",null,v(p.description),1),n("div",Be,[n("span",Ee,"v"+v(p.version),1),n("span",Re,v(p.author),1)])],8,Ne))),128))])])),K.value?(u(),d("div",os,[n("div",rs,[s[7]||(s[7]=n("div",{class:"dice-cup"},"🎲",-1)),n("div",cs,[n("div",ds,v(((M=h.value)==null?void 0:M.description)||"天道裁决"),1),(V=h.value)!=null&&V.target?(u(),d("div",us,"目标值: ≤"+v(h.value.target),1)):N("",!0)]),((ne=h.value)==null?void 0:ne.result)!==void 0?(u(),d("div",vs,[n("div",{class:le(["roll-outcome",`outcome-${h.value.success?"成功":"失败"}`])},v(h.value.success?"成功":"失败"),3),n("div",fs,v(h.value.result),1)])):N("",!0)])])):N("",!0),g.value?(u(),d("div",ps,[n("div",ys,[s[8]||(s[8]=n("div",{class:"spinner"},null,-1)),n("div",hs,v(S.value),1)])])):N("",!0)])}}}),ks=Ve(gs,[["__scopeId","data-v-4073cb2f"]]);export{ks as default};
