import{d as ke,u as we,r as c,p as P,q as je,s as Ae,c as d,h as N,m as n,F,v as Q,t as f,l as Se,x as Oe,y as xe,z as Te,A as le,n as p,e as Ce,B as A,o as u}from"./index-CUW0q8gF.js";import{k as Ve}from"./marked.esm-z4go5P_g.js";import{_ as Ge}from"./_plugin-vue_export-helper-DlAUqK2U.js";const Me={class:"game-container"},Be={key:0,class:"game-selection"},We={class:"game-list"},Ne=["onClick"],Ee={class:"game-card-footer"},Re={class:"version"},Ie={class:"author"},Le={key:1,class:"game-play"},ze={class:"game-header"},He={class:"game-title"},Pe={class:"mod-id"},Je={class:"game-actions"},Ke={class:"opportunities"},Ue=["disabled"],qe={class:"game-content"},Fe={class:"status-panel"},Qe={class:"panel-content"},Xe={key:0,class:"character-status"},Ye={class:"status-key"},Ze=["innerHTML"],De={key:1,class:"no-character"},es={class:"game-main"},ss=["innerHTML"],ts={class:"input-area"},is=["disabled"],as={key:1,class:"action-input-row"},ns=["disabled"],ls=["disabled"],os={key:2,class:"success-message"},rs={key:2,class:"roll-overlay"},cs={class:"roll-panel"},ds={class:"roll-details"},us={class:"roll-type"},fs={key:0,class:"roll-target"},vs={key:0,class:"roll-result-display"},ps={class:"roll-value"},ys={key:3,class:"loading-overlay"},hs={class:"loading-spinner"},gs={class:"loading-text"},_s=ke({__name:"GameView",setup(ms){const X=Ce(),b=we(),J=c([]),g=c(""),Y=c(null),a=c(null),oe=P(()=>{var e;return((e=a.value)==null?void 0:e.display_history)||[]}),$=P(()=>{var e;return((e=a.value)==null?void 0:e.state)||a.value||{}}),Z=P(()=>{var t;const e=(t=$.value)==null?void 0:t.current_life;if(!e||typeof e!="object")return null;const s={};for(const[i,l]of Object.entries(e))if(l!=null&&l!==""&&l!==0){if(Array.isArray(l)&&l.length===0||typeof l=="object"&&!Array.isArray(l)&&Object.keys(l).length===0)continue;s[i]=l}return Object.keys(s).length>0?s:null}),S=c(""),E=P(()=>{var e;return((e=$.value)==null?void 0:e.is_processing)||!1}),m=c(!1),O=c("加载中..."),K=c(!1),_=c(null),x=c(!1),R=c(!1);let r=null;const k=c(!1),T=c(!0),I=c();async function D(){try{m.value=!0;const e=await fetch("/api/game/mods",{headers:{Authorization:`Bearer ${b.token}`}});e.ok?J.value=await e.json():p.error("加载游戏列表失败")}catch(e){console.error("加载mod列表失败:",e),p.error("网络错误")}finally{m.value=!1}}async function re(e){T.value=!0,g.value=e,Y.value=J.value.find(s=>s.game_id===e),await ce()}async function ce(){try{m.value=!0,O.value="正在初始化游戏...";const e=await fetch("/api/game/init",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${b.token}`},body:JSON.stringify({mod_id:g.value})});if(e.ok){O.value="正在加载游戏数据...";const s=await e.json();a.value=s.state||s,O.value="正在建立实时连接...",ee()}else{const s=await e.text();console.error("[GameView] 初始化失败:",s),p.error("初始化游戏失败: "+s)}}catch(e){console.error("初始化游戏失败:",e),p.error("网络错误")}finally{m.value=!1}}function ee(){const s=`${window.location.protocol==="https:"?"wss:":"ws:"}//${window.location.host}/api/game/ws?mod_id=${g.value}&token=${b.token}`;r=new WebSocket(s),r.onopen=()=>{k.value=!0,m.value=!1,p.success("连接成功")},r.onmessage=t=>{try{const i=JSON.parse(t.data);de(i)}catch(i){console.error("[GameView] 解析WebSocket消息失败:",i)}},r.onerror=t=>{console.error("[GameView] ❌ WebSocket错误:",t),k.value=!1,p.error("连接错误")},r.onclose=t=>{k.value=!1,T.value&&g.value&&b.token&&setTimeout(()=>{ee()},3e3)}}const C=c(""),L=c(!1),w=c(null),V=c(""),z=c(!1);function de(e){var s;switch(m.value=!1,e.type){case"narrative_chunk":L.value||(L.value=!0,C.value="",a.value&&a.value.display_history&&(a.value.display_history=[...a.value.display_history,C.value])),C.value+=e.data.content;let t=C.value;const i=t.indexOf("```json");i>=0&&(t=t.substring(0,i).trim());const l=t.indexOf("```");l>=0&&(t=t.substring(0,l).trim());const o=t.match(/【判定结果：(成功|失败)】/);if(o&&!w.value){w.value=t,se(o[1]==="成功");return}if(a.value&&a.value.display_history){const G=a.value.display_history.length-1;a.value.display_history=[...a.value.display_history.slice(0,G),t]}A(()=>j());break;case"full_state":L.value=!1,z.value=!1,x.value=!1;const v=((s=a.value)==null?void 0:s.display_history)||[];a.value={...e.data,display_history:v},C.value="",V.value="",w.value=null,A(()=>j());break;case"roll_event":x.value=!0,se(e.data.success,e.data);break;case"roll_result":a.value&&a.value.display_history&&(a.value.display_history=[...a.value.display_history,e.data.content],A(()=>j()));break;case"second_stage_narrative":z.value||(z.value=!0,V.value="",a.value&&a.value.display_history&&(a.value.display_history=[...a.value.display_history,V.value])),V.value+=e.data.content;let y=V.value;const M=y.indexOf("```json");M>=0&&(y=y.substring(0,M).trim());const B=y.indexOf("```");if(B>=0&&(y=y.substring(0,B).trim()),a.value&&a.value.display_history){const G=a.value.display_history.length-1;a.value.display_history=[...a.value.display_history.slice(0,G),y],A(()=>j())}break;case"error":L.value=!1,z.value=!1,C.value="",V.value="",w.value=null,p.error(e.detail||"发生错误");break}}function se(e,s){K.value=!0,s?_.value={type:s.type||"天道裁决",target:s.target,description:s.description||"判定中...",result:s.result,success:e,outcome:s.outcome}:_.value={description:"判定中...",success:e},setTimeout(()=>{_.value&&(_.value.description=(s==null?void 0:s.description)||(e?"判定成功！":"判定失败！"))},1500),setTimeout(()=>{if(K.value=!1,_.value=null,w.value&&a.value){const t=a.value.display_history.length-1;a.value.display_history=[...a.value.display_history.slice(0,t),w.value],A(()=>j())}w.value=null},3e3)}async function ue(){if(!r||r.readyState!==WebSocket.OPEN){console.error("[GameView] WebSocket未连接"),p.error("连接未就绪，请稍候重试");return}a.value&&a.value.state&&(a.value.state.is_processing=!0),a.value&&a.value.display_history&&(a.value.display_history=[...a.value.display_history,"> 开始试炼"],A(()=>j())),m.value=!0,O.value="正在开启试炼...",r.send(JSON.stringify({action:"start_trial"}))}function te(){if(S.value.trim()&&r&&r.readyState===WebSocket.OPEN){const e=S.value.trim();a.value&&a.value.state&&(a.value.state.is_processing=!0),a.value&&a.value.display_history&&(a.value.display_history=[...a.value.display_history,`> ${e}`],A(()=>j())),r.send(JSON.stringify({action:e})),S.value=""}}async function U(){if(g.value){R.value=!0;try{const e=await fetch("/api/game/save",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${b.token}`},body:JSON.stringify({mod_id:g.value})});if(e.ok)p.success("存档成功");else{const s=await e.text();console.error("[GameView] 存档失败:",s),p.error("存档失败")}}catch(e){console.error("[GameView] 存档异常:",e),p.error("存档异常")}finally{R.value=!1}}}function fe(){confirm(`⚠️ 确定要重启机缘吗？

这将会：
• 清空所有存档数据
• 重置机缘次数为10次
• 无法恢复已删除的数据

确认继续？`)&&ve()}async function ve(){var e;try{m.value=!0,O.value="正在重启机缘...";const s=await fetch("/api/game/restart-opportunities",{method:"POST",headers:{Authorization:`Bearer ${b.token}`,"Content-Type":"application/json"}});if(s.ok){const t=await s.json();T.value=!1,r&&(r.close(),r=null),k.value=!1,g.value="",a.value=null,await D(),p.success(`机缘已重启！删除了 ${t.deleted_saves} 条存档`)}else{const t=await s.text();console.error("[GameView] 重启机缘失败 - 状态码:",s.status),console.error("[GameView] 重启机缘失败 - 响应:",t),console.error("[GameView] 重启机缘失败 - token长度:",((e=b.token)==null?void 0:e.length)||0),s.status===401?(p.error("认证失败，请重新登录"),b.logout(),X.push("/login")):p.error("重启机缘失败: "+t)}}catch(s){console.error("重启机缘失败:",s),p.error("网络错误")}finally{m.value=!1}}async function pe(){T.value=!1,g.value&&await U(),r&&(r.close(),r=null),k.value=!1,g.value="",a.value=null}async function ye(){T.value=!1,g.value&&await U(),r&&(r.close(),r=null),b.logout(),X.push("/login")}function he(e){try{let s=e.replace(/\\n/g,`
`);return s=ge(s),Ve.parse(s,{breaks:!0,gfm:!0})}catch{return e.replace(/\\n/g,"<br>").replace(/\n/g,"<br>")}}function ge(e){const s=e.split(`
`),t=[];let i=!1,l=[];for(let o=0;o<s.length;o++){const v=s[o],y=/[\s]{4,}.*[│┼↑↓←→─]|[\s]{4,}.*[├┤┬┴]|^\s*[│┼↑↓←→─├┤┬┴]/.test(v)||/^\s*[│┼↑↓←→─├┤┬┴].*[\s]{2,}/.test(v)||/^\s{8,}.*[↑↓←→]/.test(v)||v.includes("───")||v.includes("│")||v.includes("┼");y&&!i?(i=!0,l=[v]):y&&i?l.push(v):(!y&&i&&(i=!1,t.push("\n```\n"+l.join(`
`)+"\n```\n"),l=[]),t.push(v))}return i&&l.length>0&&t.push("\n```\n"+l.join(`
`)+"\n```\n"),t.join(`
`)}function _e(e){return e.startsWith("> ")?"user-message":e.startsWith("【判定结果：")?"roll-result-message":e.startsWith("【")?"system-message":"narrative-message"}function H(e){const s=[{pattern:/^(姓名|名称|角色)$/i,icon:"🧙‍♂️"},{pattern:/^(修为|经验|exp)$/i,icon:"⚡"},{pattern:/^(境界|等级|level|阶位)$/i,icon:"🏔️"},{pattern:/^(生命|血量|hp|health)$/i,icon:"❤️"},{pattern:/^(寿元|寿命|年龄|age)$/i,icon:"⏳"},{pattern:/^(灵石|金币|货币|money|gold)$/i,icon:"💎"},{pattern:/^(位置|地点|location)$/i,icon:"📍"},{pattern:/^(出身|背景|origin)$/i,icon:"🏡"},{pattern:/^(天赋|才能|talent)$/i,icon:"⭐"},{pattern:/^(灵根|资质|根骨)$/i,icon:"🌿"},{pattern:/^(属性|状态|stats)$/i,icon:"📊"},{pattern:/^(功法|技能|skill)$/i,icon:"📚"},{pattern:/^(物品|道具|背包|inventory)$/i,icon:"🎒"},{pattern:/^(状态|效果|buff|debuff)$/i,icon:"💫"},{pattern:/^(事件|历史|故事|history)$/i,icon:"📜"},{pattern:/^(目标|任务|quest)$/i,icon:"🎯"},{pattern:/^(关系|人际|社交)$/i,icon:"👥"},{pattern:/^(药园|农场|种植)$/i,icon:"🌱"},{pattern:/^(悟性|智力|intelligence)$/i,icon:"🧠"},{pattern:/^(气运|运气|luck)$/i,icon:"🍀"},{pattern:/^(声望|名望|reputation)$/i,icon:"⭐"}];for(const t of s)if(t.pattern.test(e))return`${t.icon} ${e}`;return`📋 ${e}`}function q(e){if(e==null)return'<span class="empty-value">无</span>';if(typeof e=="string")return e;if(typeof e=="number")return e.toString();if(Array.isArray(e))return e.length===0?'<span class="empty-value">无</span>':e.map(s=>typeof s=="string"?`<div class="array-item">• ${s}</div>`:typeof s=="object"&&s!==null?s.名称&&s.数量?`<div class="item-entry">• ${s.名称} × ${s.数量}${s.说明?`<br><span class="item-desc">${s.说明}</span>`:""}</div>`:`<div class="array-item">• ${ae(s)}</div>`:`<div class="array-item">• ${s}</div>`).join("");if(typeof e=="object"){if(e.人生目标||e.立即目标||e.阶段目标){let s='<div class="goal-system-container">';return e.人生目标&&(s+='<div class="goal-section goal-life">',s+='<div class="goal-section-title">🌟 人生目标</div>',s+='<div class="goal-section-content">',e.人生目标.描述&&(s+=`<div class="goal-field"><span class="field-label">描述：</span>${e.人生目标.描述}</div>`),e.人生目标.核心动机&&(s+=`<div class="goal-field"><span class="field-label">核心动机：</span>${e.人生目标.核心动机}</div>`),e.人生目标.最终愿景&&(s+=`<div class="goal-field"><span class="field-label">最终愿景：</span>${e.人生目标.最终愿景}</div>`),e.人生目标.宿命纠葛&&Array.isArray(e.人生目标.宿命纠葛)&&e.人生目标.宿命纠葛.length>0&&(s+=`<div class="goal-field"><span class="field-label">宿命纠葛：</span><div class="field-list">${e.人生目标.宿命纠葛.map(t=>`<div class="list-item">• ${t}</div>`).join("")}</div></div>`),s+="</div></div>"),e.立即目标&&(s+='<div class="goal-section goal-immediate">',s+='<div class="goal-section-title">⚡ 立即目标</div>',s+='<div class="goal-section-content">',e.立即目标.描述&&(s+=`<div class="goal-field"><span class="field-label">描述：</span>${e.立即目标.描述}</div>`),e.立即目标.紧迫程度&&(s+=`<div class="goal-field"><span class="field-label">紧迫程度：</span><span class="urgency-badge urgency-${e.立即目标.紧迫程度}">${e.立即目标.紧迫程度}</span></div>`),e.立即目标.完成条件&&(s+=`<div class="goal-field"><span class="field-label">完成条件：</span>${e.立即目标.完成条件}</div>`),e.立即目标.奖励预期&&(s+=`<div class="goal-field"><span class="field-label">奖励预期：</span>${e.立即目标.奖励预期}</div>`),s+="</div></div>"),e.阶段目标&&(s+='<div class="goal-section goal-stage">',s+='<div class="goal-section-title">📈 阶段目标</div>',s+='<div class="goal-section-content">',e.阶段目标.描述&&(s+=`<div class="goal-field"><span class="field-label">描述：</span>${e.阶段目标.描述}</div>`),e.阶段目标.关键节点&&Array.isArray(e.阶段目标.关键节点)&&e.阶段目标.关键节点.length>0&&(s+=`<div class="goal-field"><span class="field-label">关键节点：</span><div class="field-list">${e.阶段目标.关键节点.map(t=>`<div class="list-item">• ${t}</div>`).join("")}</div></div>`),e.阶段目标.障碍分析&&(s+=`<div class="goal-field"><span class="field-label">障碍分析：</span>${e.阶段目标.障碍分析}</div>`),e.阶段目标.解决路径&&(s+=`<div class="goal-field"><span class="field-label">解决路径：</span>${e.阶段目标.解决路径}</div>`),s+="</div></div>"),s+="</div>",s}return e.姓名||e.境界||e.修为||e.灵根?me(e):ie(e)}return String(e)}function me(e){let s='<div class="attributes-expanded">';const t=["姓名","出身","灵根","境界","寿元","生命值","修为","灵石","根骨","悟性","气运","初始天赋","功法","神通","物品","状态效果","关系网","声望","特殊标记","灵兽","道侣","洞府","药园"];return t.forEach(i=>{e[i]!==void 0&&e[i]!==null&&e[i]!==""&&!(Array.isArray(e[i])&&e[i].length===0)&&!(typeof e[i]=="object"&&!Array.isArray(e[i])&&Object.keys(e[i]).length===0)&&(s+=`<div class="attr-sub-item">
        <div class="attr-sub-key">${H(i)}</div>
        <div class="attr-sub-value">${q(e[i])}</div>
      </div>`)}),Object.keys(e).forEach(i=>{!t.includes(i)&&e[i]!==void 0&&e[i]!==null&&e[i]!==""&&!(Array.isArray(e[i])&&e[i].length===0)&&!(typeof e[i]=="object"&&!Array.isArray(e[i])&&Object.keys(e[i]).length===0)&&(s+=`<div class="attr-sub-item">
        <div class="attr-sub-key">${H(i)}</div>
        <div class="attr-sub-value">${q(e[i])}</div>
      </div>`)}),s+="</div>",s}function ie(e,s=0){const t=Object.entries(e).filter(([l,o])=>!(o==null||o===""||Array.isArray(o)&&o.length===0||typeof o=="object"&&!Array.isArray(o)&&Object.keys(o).length===0));if(t.length===0)return'<span class="empty-value">无</span>';let i='<div class="object-expanded">';return t.forEach(([l,o])=>{i+='<div class="object-item">',i+=`<div class="object-key">${H(l)}</div>`,i+='<div class="object-value">',o==null?i+='<span class="empty-value">无</span>':typeof o=="string"||typeof o=="number"||typeof o=="boolean"?i+=String(o):Array.isArray(o)?i+=be(o,s+1):typeof o=="object"?i+=ie(o,s+1):i+=String(o),i+="</div>",i+="</div>"}),i+="</div>",i}function be(e,s=0){if(e.length===0)return'<span class="empty-value">无</span>';let t='<div class="array-container">';return e.forEach(i=>{t+='<div class="array-item-wrapper">',typeof i=="string"||typeof i=="number"||typeof i=="boolean"?t+=`<div class="array-item-simple">• ${i}</div>`:typeof i=="object"&&i!==null?(t+='<div class="array-item-object">',t+=ae(i),t+="</div>"):t+=`<div class="array-item-simple">• ${i}</div>`,t+="</div>"}),t+="</div>",t}function ae(e){const s=Object.entries(e);if(s.length===0)return'<span class="empty-value">无</span>';let t='<div class="inline-object">';return s.forEach(([i,l])=>{l==null||l===""||(t+='<div class="inline-item">',t+=`<span class="inline-key">${i}:</span> `,typeof l=="string"||typeof l=="number"||typeof l=="boolean"?t+=`<span class="inline-value">${l}</span>`:Array.isArray(l)?t+=`<span class="inline-value">[${l.length}项]</span>`:typeof l=="object"?t+='<span class="inline-value">{对象}</span>':t+=`<span class="inline-value">${l}</span>`,t+="</div>")}),t+="</div>",t}function $e(){var s;if(!k.value)return"连接中...";const e=((s=$.value)==null?void 0:s.opportunities_remaining)??10;return e<=0?"机缘已尽":e===10?"开始第一次试炼":"开启下一次试炼"}function j(){I.value&&(I.value.scrollTop=I.value.scrollHeight)}return je(()=>{D()}),Ae(()=>{T.value=!1,r&&(r.close(),r=null),k.value=!1}),(e,s)=>{var t,i,l,o,v,y,M,B,G,ne;return u(),d("div",Me,[g.value?(u(),d("div",Le,[n("header",ze,[n("div",He,[n("h2",null,f((t=Y.value)==null?void 0:t.name),1),n("span",Pe,f(g.value),1)]),n("div",Je,[n("span",Ke,[s[3]||(s[3]=Se(" 剩余机缘: ",-1)),n("strong",null,f(((i=$.value)==null?void 0:i.opportunities_remaining)??10),1)]),n("button",{onClick:U,class:"btn-save",disabled:R.value},f(R.value?"存档中...":"💾 手动存档"),9,Ue),n("button",{onClick:fe,class:"btn-restart",title:"清空所有存档，重新开始"}," 🔄 重启机缘 "),n("button",{onClick:pe,class:"btn-secondary"},"切换游戏"),n("button",{onClick:ye,class:"btn-danger"},"退出")])]),n("div",qe,[n("aside",Fe,[s[5]||(s[5]=n("div",{class:"panel-header"},[n("h3",null,"角色状态")],-1)),n("div",Qe,[Z.value?(u(),d("div",Xe,[(u(!0),d(F,null,Q(Z.value,(h,W)=>(u(),d("div",{key:W,class:"status-item"},[n("div",Ye,f(H(W)),1),n("div",{class:"status-value",innerHTML:q(h)},null,8,Ze)]))),128))])):(u(),d("div",De,[...s[4]||(s[4]=[n("p",null,"尚未开始冒险",-1)])]))])]),n("main",es,[n("div",{class:"narrative-window",ref_key:"narrativeWindow",ref:I},[(u(!0),d(F,null,Q(oe.value,(h,W)=>(u(),d("div",{key:W,class:le(["narrative-block",_e(h)]),innerHTML:he(h)},null,10,ss))),128))],512),n("footer",ts,[!((l=$.value)!=null&&l.is_in_trial)&&!((o=$.value)!=null&&o.daily_success_achieved)?(u(),d("button",{key:0,onClick:ue,disabled:!k.value||E.value||x.value||(((v=$.value)==null?void 0:v.opportunities_remaining)??0)<=0,class:"btn-start"},f($e()),9,is)):(y=$.value)!=null&&y.is_in_trial?(u(),d("div",as,[Oe(n("input",{"onUpdate:modelValue":s[0]||(s[0]=h=>S.value=h),type:"text",placeholder:"汝欲何为...",onKeydown:Te(te,["enter"]),disabled:E.value||x.value,class:"action-input"},null,40,ns),[[xe,S.value]]),n("button",{onClick:te,disabled:E.value||x.value||!S.value.trim(),class:"btn-primary"},f(E.value?"处理中...":x.value?"判定中...":"行动"),9,ls)])):(M=$.value)!=null&&M.daily_success_achieved?(u(),d("div",os,[...s[6]||(s[6]=[n("p",null,"🎉 今日功德圆满！明日再来。",-1)])])):N("",!0)])])])])):(u(),d("div",Be,[s[2]||(s[2]=n("div",{class:"selection-header"},[n("h1",null,"选择你的冒险"),n("p",null,"在不同的世界中展开独一无二的旅程")],-1)),n("div",We,[(u(!0),d(F,null,Q(J.value,h=>(u(),d("div",{key:h.game_id,class:"game-card",onClick:W=>re(h.game_id)},[s[1]||(s[1]=n("div",{class:"game-card-icon"},"🎮",-1)),n("h3",null,f(h.name),1),n("p",null,f(h.description),1),n("div",Ee,[n("span",Re,"v"+f(h.version),1),n("span",Ie,f(h.author),1)])],8,Ne))),128))])])),K.value?(u(),d("div",rs,[n("div",cs,[s[7]||(s[7]=n("div",{class:"dice-cup"},"🎲",-1)),n("div",ds,[n("div",us,f(((B=_.value)==null?void 0:B.description)||"天道裁决"),1),(G=_.value)!=null&&G.target?(u(),d("div",fs,"目标值: ≤"+f(_.value.target),1)):N("",!0)]),((ne=_.value)==null?void 0:ne.result)!==void 0?(u(),d("div",vs,[n("div",{class:le(["roll-outcome",`outcome-${_.value.success?"成功":"失败"}`])},f(_.value.success?"成功":"失败"),3),n("div",ps,f(_.value.result),1)])):N("",!0)])])):N("",!0),m.value?(u(),d("div",ys,[n("div",hs,[s[8]||(s[8]=n("div",{class:"spinner"},null,-1)),n("div",gs,f(O.value),1)])])):N("",!0)])}}}),ws=Ge(_s,[["__scopeId","data-v-a1e0337b"]]);export{ws as default};
